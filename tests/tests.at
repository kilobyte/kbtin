AT_SETUP([no profiling])
AT_DATA([testin], [#rem Profiling should be disabled in release versions.
#profile
])
AT_DATA([expout], [#UNKNOWN TINTIN-COMMAND: [#profile]
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP


AT_SETUP([#showme])
AT_DATA([testin], [#showme abc def ghi
#showme { blah}
#var x foo
#showme $x
])
AT_DATA([expout], [abc def ghi
 blah
foo
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP


AT_SETUP([#showme with non-ASCII chars])
AT_DATA([testin], [#showme ąęść
#showme abcąęśćdefабцдефгхийאבגדァアィイ
#showme abc𠀧𠀀𠀁𠀂
])
AT_DATA([expout], [ąęść
abcąęśćdefабцдефгхийאבגדァアィイ
abc𠀧𠀀𠀁𠀂
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP



AT_SETUP([#reverse])
AT_DATA([testin], [#var x blahąęśćabc
#reverse x $x
#showme $x
])
AT_DATA([expout], [cbaćśęąhalb
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP


AT_SETUP([#postpad])
AT_DATA([testin], [#postpad tmp 5 abcdefgh;#showme {$tmp|}
#postpad tmp 5 abćdęfgh;#showme {$tmp|}
#postpad tmp 5 ab;#showme {$tmp|}
#postpad tmp 5 ać;#showme {$tmp|}
#var x foo
#postpad tmp 5 {a$x};#showme {$tmp|}
#postpad tmp 5 a ć;#showme {$tmp|}
])
AT_DATA([expout], [abcde|
abćdę|
ab   |
ać   |
afoo |
a ć  |
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#prepad])
AT_DATA([testin], [#prepad tmp 5 abcdefgh;#showme {$tmp|}
#prepad tmp 5 abćdęfgh;#showme {$tmp|}
#prepad tmp 5 ab;#showme {$tmp|}
#prepad tmp 5 ać;#showme {$tmp|}
#var x foo
#prepad tmp 5 {a$x};#showme {$tmp|}
#prepad tmp 5 a ć;#showme {$tmp|}
])
AT_DATA([expout], [abcde|
abćdę|
   ab|
   ać|
 afoo|
  a ć|
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#substr])
AT_DATA([testin], [#substr tmp 3 abcde;#showme {$tmp}
#substr tmp 2,3 abcde;#showme {$tmp}
#substr tmp 4,1000 abcde;#showme {$tmp}
#substr tmp 2,4 ąbćdef;#showme {$tmp}
])
AT_DATA([expout], [c
bc
de
bćd
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([late var substitution])
AT_DATA([testin], [#var x A1
#alias foo {#alias bar {#showme $x}}
foo
bar
#var x B1
bar
#var x C1
foo
#var x D1
bar
#var x A2
#alias foo {#alias bar {#showme $$x}}
foo
bar
#var x B2
bar
#var x C2
foo
#var x D2
bar
#var x A3
#alias foo {#alias bar {#showme $$$x}}
foo
bar
#var x B3
bar
#var x C3
foo
#var x D3
bar
])
AT_DATA([expout], [A1
B1
D1
A2
A2
C2
A3
A3
A3
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#system])
AT_DATA([testin], [#var x abc
#sys echo '$x'
#sys {echo '$x'}
])
AT_DATA([expout], [abc
abc
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#shell])
AT_DATA([testin], [#shell echo 'abc'
])
AT_DATA([expout], [abc
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#run])
AT_DATA([testin], [#hook close {#showme FIN;#end}
#run a echo blah
])
AT_DATA([expout], [blah
FIN
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#run and 16bit Unicode])
AT_DATA([testin], [#hook close {#showme FIN;#end}
#run a echo abcąęśćdefабцдефгхийאבגדァアィイ
])
AT_DATA([expout], [abcąęśćdefабцдефгхийאבגדァアィイ
FIN
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#run and non-BMP Unicode])
AT_DATA([testin], [#hook close {#showme FIN;#end}
#run a echo abc𠀧𠀀𠀁𠀂
])
AT_DATA([expout], [abc𠀧𠀀𠀁𠀂
FIN
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#goto])
AT_DATA([testin], [#route a b {#showme A>B}
#route b c {#showme B>C}
#goto A B;#showme -=-
#goto a b;#showme -=-
#goto a c;#showme -=-
#route a c {#showme A>C} 5
#goto a c;#showme -=-
#route a c {#showme A>C} 21
#goto a c;#showme -=-
#goto a {};#showme -=-
#goto {} b;#showme -=-
#goto {} {};#showme -=-
a>b;#showme -=-
>c;#showme -=-
#showme ($loc)
])
AT_DATA([expout], [#Location not found: [A]
-=-
A>B
-=-
A>B
B>C
-=-
A>C
-=-
A>B
B>C
-=-
#SYNTAX: #goto <from> <to>
-=-
#SYNTAX: #goto <from> <to>
-=-
#SYNTAX: #goto <from> <to>
-=-
A>B
-=-
B>C
-=-
(c)
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#end w/o sessions])
AT_DATA([testin], [#end
])
AT_DATA([expout], [])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#end with a session])
AT_DATA([testin], [#run a cat
#end
])
AT_DATA([expout], [
#SESSION 'a' DIED.
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([action priorities])
AT_DATA([testin], [#act {aaa%0} {#showme act: a} {a}
#act {aaa%1} {#showme act: 0} {0}
#act {aaa%2} {#showme act: 0.09} {0.09}
#act {aaa%3} {#showme act: 0.1} {0.1}
#act {aaa%4} {#showme act: 0.10} {0.10}
#act {aaa%5} {#showme act: 0.19} {0.19}
#act {aaa%6} {#showme act: 0a.1} {0a.1}
#act {aaa%7} {#showme act: a06z} {a06z}
#act {aaa%8} {#showme act: a6x} {a6x}
#act {aaa%9} {#showme act: 0.2} {0.2}
#doact aaa
])
AT_DATA([expout], [act: 0
act: 0.1
act: 0.2
act: 0.09
act: 0.10
act: 0.19
act: 0a.1
act: a
act: a6x
act: a06z
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([actions, promptactions])
AT_DATA([testin], [#hook close {#showme FIN;#end}
#act {foo} {#showme <foo>}
#promptact {fo} {#showme <fo...>}
#run a {sh -c "echo -n 'fo';sleep 2;echo 'o'"}
])
AT_DATA([expout], [<fo...>
<fo...>
<foo>
foo
FIN
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#chr, #ord, #hexord (7-bit ASCII)])
AT_DATA([testin], [#chr x {98 108 97 104};#showme {$x}
#chr x U+0062 U+006C U+0061 U+0068;#showme {$x}
#chr x 98 0x6c 97 U+0068;#showme {$x}
#ord x blah;#showme {$x}
#hexord x blah;#showme {$x}
])
AT_DATA([expout], [blah
blah
blah
98 108 97 104
U+0062 U+006C U+0061 U+0068
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([UTF-8 transformation])
AT_DATA([testin], [#hexord x abcąęśćdefабцдефгхийאבגדァアィイ;#showme {$x}
#chr x U+20027 U+20000 U+20001 U+20002;#hexord x $x;#showme {$x}
#var i 1;#loop 1,20 {#math i $i*2;#math l $i-1;#math r $i+1;#chr x $l $i $r;#hexord x {$x};#show $x}
#show last test
#chr x U+10ffff;#hexord x $x;#showme {$x}
])
AT_DATA([expout], [U+0061 U+0062 U+0063 U+0105 U+0119 U+015B U+0107 U+0064 U+0065 U+0066 U+0430 U+0431 U+0446 U+0434 U+0435 U+0444 U+0433 U+0445 U+0438 U+0439 U+05D0 U+05D1 U+05D2 U+05D3 U+30A1 U+30A2 U+30A3 U+30A4
U+20027 U+20000 U+20001 U+20002
U+0001 U+0002 U+0003
U+0003 U+0004 U+0005
U+0007 U+0008 U+0009
U+000F U+0010 U+0011
U+001F U+0020 U+0021
U+003F U+0040 U+0041
U+007F U+FFFD U+FFFD
U+00FF U+0100 U+0101
U+01FF U+0200 U+0201
U+03FF U+0400 U+0401
U+07FF U+0800 U+0801
U+0FFF U+1000 U+1001
U+1FFF U+2000 U+2001
U+3FFF U+4000 U+4001
U+7FFF U+8000 U+8001
U+FFFF U+10000 U+10001
U+1FFFF U+20000 U+20001
U+3FFFF U+40000 U+40001
U+7FFFF U+80000 U+80001
U+FFFFF U+100000 U+100001
last test
U+10FFFF
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#ord as inline])
AT_DATA([testin], [#if {65==#ord A} {#show 1} #else {#show 0}
#if {64==#ord A} {#show 1} #else {#show 0}
#if {65=#ord} {#show 1} #else {#show 0}
])
AT_DATA([expout], [1
0
#ord: no argument
0
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#textin])
AT_DATA([testin], [#sys {rm -rf testtmp}
#ali x #deathlog testtmp
x abc
x
x def
x
x ghi
x
x
x jkl
x
x {#abc;#bde}
x ąęść
x abc𠀧𠀀𠀁𠀂
x
#delay 1 #end
#run a cat
#text testtmp
#unlink testtmp
])
AT_DATA([expout], [#File read - Success.
abc

def

ghi


jkl

#abc;#bde
ąęść
abc𠀧𠀀𠀁𠀂


#SESSION 'a' DIED.
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([session cleanup notification])
AT_DATA([testin], [#ali down {#ali down #delay 1 #zap}
#hook close #main down
#run a sh -c 'sleep 2'
#run b sh -c 'echo foo'
])
AT_DATA([expout], [foo

#SESSION 'b' DIED.
#SESSION 'a' ACTIVATED.

#SESSION 'a' DIED.
#THERE'S NO ACTIVE SESSION NOW.
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([FormFeed])
AT_DATA([testin], [#chr ff 12
#showme bare${ff}fin
#sys {echo -e 'bare\014fin'}
#sys {echo -e 'cls0\033[0Jfin'}
#sys {echo -e 'cls1\033[1Jfin'}
#sys {echo -e 'cls2\033[2Jfin'}
#rem ]]] (dumb m4)
])
AT_DATA([expout], [barefin
barefin
cls0fin
cls1fin
cls2fin
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#strlen and CJK/combining chars])
AT_DATA([testin], [#strlen tmp {sanity check};#showme $tmp
#strlen tmp {};#showme $tmp
#strlen tmp {abcąęśćdefабцдефгхийאבגדァアィイ};#showme $tmp
#math tmp {#strlen {ィ}};#showme $tmp
#chr tmp {97 U+0300 97 U+0301 97 U+0302};#strlen tmp {$tmp};#showme $tmp
])
AT_DATA([expout], [12
0
32
2
3
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#substr and CJK/combining chars])
AT_DATA([testin], [#showme NORMAL
#substr tmp 2,3 blah;#showme A($tmp)
#substr tmp 2,4 blah;#showme B($tmp)
#substr tmp 2,5 blah;#showme C($tmp)
#substr tmp 4,4 blah;#showme D($tmp)
#showme NORMAL + COMBINING
#substr tmp 2,3 b́ĺáh́;#showme A($tmp)
#substr tmp 2,4 b́ĺáh́;#showme B($tmp)
#substr tmp 2,5 b́ĺáh́;#showme C($tmp)
#substr tmp 4,4 b́ĺáh́;#showme D($tmp)
#showme CJK
#substr tmp 3,4 ァアィイ;#showme A($tmp)
#substr tmp 2,5 ァアィイ;#showme B($tmp)
#substr tmp 3,3 ァアィイ;#showme C($tmp)
#substr tmp 8,9 ァアィイ;#showme D($tmp)
#substr tmp 7,8 ァアィイ;#showme E($tmp)
#showme CJK + COMBINING
#substr tmp 3,4 ァ́ア́ィ́イ́;#showme A($tmp)
#substr tmp 2,5 ァ́ア́ィ́イ́;#showme B($tmp)
#substr tmp 3,3 ァ́ア́ィ́イ́;#showme C($tmp)
#substr tmp 8,9 ァ́ア́ィ́イ́;#showme D($tmp)
#substr tmp 7,8 ァ́ア́ィ́イ́;#showme E($tmp)
])
AT_DATA([expout], [NORMAL
A(la)
B(lah)
C(lah)
D(h)
NORMAL + COMBINING
A(ĺá)
B(ĺáh́)
C(ĺáh́)
D(h́)
CJK
A(ア)
B( ア )
C( )
D( )
E(イ)
CJK + COMBINING
A(ア́)
B( ア́ )
C( )
D( )
E(イ́)
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#postpad and CJK/combining chars])
AT_DATA([testin], [#showme NORMAL
#postpad tmp 3 blah;#showme A($tmp)
#postpad tmp 5 blah;#showme B($tmp)
#showme NORMAL + COMBINING
#postpad tmp 3 b́ĺáh́;#showme A($tmp)
#postpad tmp 5 b́ĺáh́;#showme B($tmp)
#showme CJK
#postpad tmp 3 ァアィイ;#showme A($tmp)
#postpad tmp 9 ァアィイ;#showme B($tmp)
#showme CJK + COMBINING
#postpad tmp 3 ァ́ア́ィ́イ́;#showme A($tmp)
#postpad tmp 9 ァ́ア́ィ́イ́;#showme B($tmp)
])
AT_DATA([expout], [NORMAL
A(bla)
B(blah )
NORMAL + COMBINING
A(b́ĺá)
B(b́ĺáh́ )
CJK
A(ァ )
B(ァアィイ )
CJK + COMBINING
A(ァ́ )
B(ァ́ア́ィ́イ́ )
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#prepad and CJK/combining chars])
AT_DATA([testin], [#showme NORMAL
#prepad tmp 3 blah;#showme A($tmp)
#prepad tmp 5 blah;#showme B($tmp)
#showme NORMAL + COMBINING
#prepad tmp 3 b́ĺáh́;#showme A($tmp)
#prepad tmp 5 b́ĺáh́;#showme B($tmp)
#showme CJK
#prepad tmp 3 ァアィイ;#showme A($tmp)
#prepad tmp 9 ァアィイ;#showme B($tmp)
#showme CJK + COMBINING
#prepad tmp 3 ァ́ア́ィ́イ́;#showme A($tmp)
#prepad tmp 9 ァ́ア́ィ́イ́;#showme B($tmp)
])
AT_DATA([expout], [NORMAL
A(bla)
B( blah)
NORMAL + COMBINING
A(b́ĺá)
B( b́ĺáh́)
CJK
A( ァ)
B( ァアィイ)
CJK + COMBINING
A( ァ́)
B( ァ́ア́ィ́イ́)
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#time])
AT_DATA([testin], [#time tmp 345;#showme $tmp
#time tmp 1y 245d 15h 30m 4s;#showme $tmp
#time tmp 11 hours, 59 minutes and 45 seconds;#showme $tmp
#time tmp 2 weeks 1 d;#showme $tmp
])
AT_DATA([expout], [345
52759804
43185
1296000
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP(["#logtype ttyrec" and ttyrec2ansi])
AT_DATA([testin], [#hook open {#log testlog.ttyrec;#logcomment abc}
#hook close {#log;#system {ttyrec2ansi <testlog.ttyrec};#unlink testlog.ttyrec;#end}
#logtype ttyrec
#run a {echo def}
])
AT_DATA([expout], [def
abc
def
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP

AT_SETUP([#localtime, #gmtime])
AT_DATA([testin], [#localtime foo 1189969300;#showme $foo
#gmtime foo 1189969300;#showme $foo
])
AT_DATA([expout], [40 1 21  16 8 2007  0 258 1
40 1 19  16 8 2007  0 258 0
])
AT_CHECK([runtest.sh],,[expout])
AT_CLEANUP
